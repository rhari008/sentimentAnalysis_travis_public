'use strict';

//Include
var sql = require('./sqlStatement');
var linksSQL = require ("./createLinksSQLStatements");

exports.createDeleteLinksStatements = function (context, asyncDone) {
	linksSQL.createLinksStatements(context, true);
	return asyncDone(null, context);
};

/******************** MxN relationships ***********************/

exports.createDeleteLinksMNStatements = function (context, asyncDone) {
    var dbSegLast = context.oData.dbSegmentLast,
	    sqlContext = linksSQL.createMNSQLContext(context, dbSegLast);

    context.sql = sqlContext;
    dbSegLast.sql.stmContainer = new sql.PostContainer();

    createMNDeleteStatementContainer(sqlContext);
    return asyncDone(null, context);
};

function createMNDeleteStatementContainer(sqlContext) {
    var dbSeg = sqlContext.dbSegLast;

    linksSQL.createMNStatementContainer(sqlContext);

    //create insert statement for master table
    dbSeg.sql.stmContainer.insertTmp = masterMNTableInsertToDel(sqlContext, dbSeg.sql.rId);

    //create insert statement for master table
    dbSeg.sql.stmContainer.delete = masterMNTableDelete(sqlContext, dbSeg.sql.rId);
}

function masterMNTableInsertToDel(sqlContext, rId) {
    sqlContext.context.logger.debug('createDeleteLinksStatements', 'masterMNTableInsertToDel');
    var dbSeg = sqlContext.dbSegLast;

    var subSelect = new sql.Select();
    subSelect.addSelects(dbSeg.getOverPropertiesForSelect(''));
    subSelect.setFrom( {table: dbSeg.getOver().object} );
    subSelect.addWhereKeyValuePairs(dbSeg.getOverPropertiesWithValues());

    var stm = new sql.Insert();
    stm.setTableName({table: rId});
    stm.setSubSelect(subSelect);

    return stm;
}

function masterMNTableDelete(sqlContext) {
    sqlContext.context.logger.debug('createDeleteLinksStatements', 'masterMNTableDelete');
    var dbSeg = sqlContext.dbSegLast;

    var deleteStmt = new sql.Delete();
    deleteStmt.setFrom( {table: dbSeg.getOver().object} );

    deleteStmt.addWhereKeyValuePairs(dbSeg.getOverPropertiesWithValues());

    return deleteStmt;
}
